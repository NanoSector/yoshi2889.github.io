<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Autostarting, auto-updating, rootless Podman containers | Nano's Blog</title>
<meta name=keywords content="howto,software">
<meta name=description content="Pods for picky perfectionists">
<meta name=author content="Rick">
<link rel=canonical href=https://www.nanosector.nl/posts/podman-rootless-autostart/>
<link href=/assets/css/stylesheet.min.0ab163365a09a7badcaa1640eade25dd796572c29910423eab9d2716760ce44e.css integrity="sha256-CrFjNloJp7rcqhZA6t4l3XllcsKZEEI+q50nFnYM5E4=" rel="preload stylesheet" as=style>
<link rel=icon href=https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<meta property="og:title" content="Autostarting, auto-updating, rootless Podman containers">
<meta property="og:description" content="Pods for picky perfectionists">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.nanosector.nl/posts/podman-rootless-autostart/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-16T19:20:00+01:00">
<meta property="article:modified_time" content="2022-01-16T19:20:00+01:00"><meta property="og:site_name" content="Nano's Blog">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Autostarting, auto-updating, rootless Podman containers">
<meta name=twitter:description content="Pods for picky perfectionists">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.nanosector.nl/posts/"},{"@type":"ListItem","position":2,"name":"Autostarting, auto-updating, rootless Podman containers","item":"https://www.nanosector.nl/posts/podman-rootless-autostart/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Autostarting, auto-updating, rootless Podman containers","name":"Autostarting, auto-updating, rootless Podman containers","description":"Pods for picky perfectionists","keywords":["howto","software"],"articleBody":"I doubt I’ll be alone when I say that my server setup is a mess. It is a monolith of different services slammed together on the same machine. Some run on the bare metal, some run in a VM, some run in containers.\nRecently I put some work into migrating my applications away from bare metal and into containers. While that effort is not complete just yet, it has already broken on me after podman-compose stopped creating pods per compose file. Apparently that was a bug, and I relied on this behaviour with a wrapper script.\nThe sequence this script followed is rather simple:\n Remove any existing podman-generated systemd unit files from ~/.config/systemd/system Run podman-compose up Generate new system files with podman generate systemd Move all *.service files generated to the ~/.config/systemd/system directory  However, this relied on the previous behaviour in podman-compose which created a pod for all services to live in per compose file, so it can guess the pod name and generate a set of systemd units for it with one invocation of the podman generate systemd command. Nifty, worked for a while, but now it’s time to move on.\nThe puzzle pieces Let’s lay out what we want to achieve.\n For security, containers should be rootless For maintainability, containers should be defined in a docker-compose.yml file For usability, containers should auto-start on boot Purely for the sake of laziness we’ll throw in the extra requirement that containers should be self-updating  This might haunt me later. We’ll see about that, but because of this it should be trivial to disable    Target 1: Rootless I refuse to run my containers in a rootful environment. I strongly believe that podman is designed to remedy this design decision in Docker and I should take advantage of that.\nMy containers run as a separate podman user with virtually no privileges on the system. Most containers run the software they host under a different user as well, which means that it’s practically impossible for container X to touch container Y’s files.\nThis imposes challenges when you want to share folders between containers, but that’s something a little GID magic can solve; give the containers the same GID and set a restrictive permission mask on that, so the actual owner gets write permissions yet other containers get read permission only.\nTarget 2: docker-compose The standard docker-compose now works with podman v3!\nA standard docker-compose.yml file should be sufficient. As an example, below is the configuration file for my Nextcloud instance:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  version:'3'services:db:image:postgres:alpinerestart:alwaysvolumes:- /containers/nextcloud/db:/var/lib/postgresql/dataenvironment:- POSTGRES_PASSWORD=VERY_SECURE_POSTGRESQL_PASSWORD_HEREredis:image:redis:alpinerestart:alwaysapp:image:nextcloud:apacherestart:alwaysports:- 81:80volumes:- /containers/nextcloud/html:/var/www/html- /mnt/storage/Nextcloud:/var/www/html/dataenvironment:- POSTGRES_HOST=db- POSTGRES_PASSWORD=VERY_SECURE_NEXTCLOUD_POSTGRESQL_PASSWORD_HERE- POSTGRES_DB=nextcloud- POSTGRES_USER=ncuser- REDIS_HOST=redisenv_file:- db.envdepends_on:- db- rediscron:image:nextcloud:apacherestart:alwaysvolumes:- /containers/nextcloud/html:/var/www/html- /mnt/storage/Nextcloud:/var/www/html/dataentrypoint:/cron.shdepends_on:- db- redisonlyoffice:image:'onlyoffice/documentserver'ports:- '9980:80'environment:DB_TYPE:postgresDB_HOST:dbDB_PORT:5432DB_NAME:onlyofficeDB_USER:onlyofficeDB_PWD:VERY_SECURE_ONLYOFFICE_POSTGRESQL_PASSWORD_HEREJWT_ENABLED:'true'JWT_SECRET:VERY_SECURE_JWT_SECRET_HEREvolumes:- /containers/onlyoffice/logs:/var/log/onlyoffice- /containers/onlyoffice/certificates:/var/www/onlyoffice/Datadepends_on:- dbrestart:always  The only thing really of note is that every service has restart: always set. This will be explained later.\n Please note that rootless containers might not have the same privileges as a rootful container in terms of networking etcetera. Always double check the compose files you copy!\n  It is preferred that you use the podman secrets infrastructure for passwords instead of hardcoding them into this text file. This is beyond the scope of this article, do some research!\n Target 2.1: SELinux Fedora has SELinux enabled by default, and we don’t want to make Dan Walsh weep. Thankfully, setting up SELinux to play nice with your containers is trivial.\nWhat I like to do is create a /containers directory (yes, in the root folder) whose owner I set to the podman user. After this it is just a matter of making sure the directory has the right SELinux type label, which is container_file_t. You can achieve this with the following command:\n1  semanage fcontext -a -t container_file_t '/containers(/.*)?'   This will ensure that the /containers directory and all of its sub-directories and files will get the appropriate SELinux type applied. This however does not immediately apply to existing files or directories, so we can apply it by running:\n1  restorecon -Rv /containers   If all is well you should be seeing a lot of label changes being printed to the console, depending on how many files exist in this directory.\nTarget 3: Autostart on boot This took me too long to figure out, but it turns out that Podman already ships with a solution built in. Remember the restart: always that I mentioned earlier?\nIt turns out Podman ships with a systemd unit file specifically to start all containers marked to always restart. It is called podman-restart.service and it can be enabled as a user service!\n1  systemctl enable --user podman-restart.service   Start a container marked with restart: always, and then reboot your system. Nothing happens, congratulations!\nBy default, user units are only started whenever the user starts a session. Since nobody has logged in to your podman user, no session was ever started. Even worse, should someone login as the podman user, the session will start, which will start your container - and then it will get killed when that person logs out. That’s super inconvenient.\nsystemd-logind has a concept of lingering users. The loginctl man page describes it as:\n … If enabled for a specific user, a user manager is spawned for the user at boot and kept around after logouts. This allows users who are not logged in to run long-running services. …\n We can enable this for our podman user with the following command:\n1  loginctl enable-linger PODMAN-USER-HERE   Set that, reboot again and you should see it all start to come together.\nTarget 4: Automatic updates The tricky part. We can have dnf automatic updates through dnf-automatic, and Podman even has its own auto-update system! However, we cannot use this in this setup, because we do not rely on per-container systemd unit files, because we use podman-compose and the global podman-restart.service.\nInstead, what we can do is replicate the setup using custom unit files per docker-compose file. Create the following file at ~/.config/systemd/user/podman-update@.service:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  [Unit] Description=Podman auto-update service for %i Wants=network-online.target After=network-online.target [Service] WorkingDirectory=%h/infra/%i Environment=\"DOCKER_HOST=unix:%t/podman/podman.sock\" Type=oneshot ExecStart=/usr/bin/docker-compose pull ExecStartPost=/usr/bin/docker-compose up -d ExecStartPost=/usr/bin/podman image prune -f # Uncomment the following if you want to have e-mail notifications #ExecStopPost=/usr/bin/unit-status-mail-user.sh %n \"Hostname: %H\" \"Machine ID: %m\" \"Boot ID: %b\" [Install] WantedBy=default.target   This is a template file which can be used multiple times with a different input parameter (the string after the @ sign).\n Make sure to check the WorkingDirectory setting! This assumes you have your docker-compose.yml files stored in ~/infra/[subfolder]/docker-compose.yml\n And add the following timer at ~/.config/systemd/user/podman-update@.timer:\n1 2 3 4 5 6 7 8 9 10  [Unit] Description=Podman update timer for %i [Timer] OnCalendar=daily RandomizedDelaySec=900 Persistent=true [Install] WantedBy=timers.target   For every subfolder, you can now enable the timer, which will call the unit:\n1  systemctl --user enable podman-update@nextcloud.timer   Where nextcloud is a subfolder of ~/infra. Your nextcloud container will now update daily at midnight!\nBonus: Mail on unit start/failure northernlights.se has a great resource on automatically mailing unit status after a unit starts or stops.\nTo adjust this approach for user unit files, create /usr/bin/unit-status-mail-user.sh with:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  #!/bin/bash MAILTO=\"root\" MAILFROM=\"unit-status-mailer\" UNIT=$1 EXTRA=\"\" for e in \"${@:2}\"; do EXTRA+=\"$e\"$'\\n' done UNITSTATUS=$(systemctl status --user $UNIT) sendmail $MAILTO From:$MAILFROM To:$MAILTO Subject:Status mail for unit: $UNIT Status report for unit: $UNIT $EXTRA $UNITSTATUS EOF echo -e \"Status mail sent to: $MAILTOfor unit: $UNIT\"   Then uncomment the commented line in the systemd service above. Don’t forget to chmod +x the file and add SELinux rules:\n1 2 3  chmod +x /usr/bin/unit-status-mail.sh /usr/bin/unit-status-mail-user.sh restorecon -vF /usr/bin/unit-status-mail.sh restorecon -vF /usr/bin/unit-status-mail-user.sh   ","wordCount":"1334","inLanguage":"en","datePublished":"2022-01-16T19:20:00+01:00","dateModified":"2022-01-16T19:20:00+01:00","author":{"@type":"Person","name":"Rick"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.nanosector.nl/posts/podman-rootless-autostart/"},"publisher":{"@type":"Organization","name":"Nano's Blog","logo":{"@type":"ImageObject","url":"https://www.nanosector.nl/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://www.nanosector.nl/ accesskey=h title="Nano's Blog (Alt + H)">Nano's Blog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://www.nanosector.nl/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
<li>
<a href=https://www.nanosector.nl/tags/ title=tags>
<span>tags</span>
</a>
</li></ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Autostarting, auto-updating, rootless Podman containers
</h1>
<div class=post-description>
Pods for picky perfectionists
</div>
<div class=post-meta>
January 16, 2022&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Rick
</div>
</header>
<div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<div class=details>Table of Contents</div>
</summary>
<div class=inner><ul><li>
<a href=#the-puzzle-pieces aria-label="The puzzle pieces">The puzzle pieces</a></li><li>
<a href=#target-1-rootless aria-label="Target 1: Rootless">Target 1: Rootless</a></li><li>
<a href=#target-2-docker-compose aria-label="Target 2: docker-compose">Target 2: docker-compose</a><ul>
<li>
<a href=#target-21-selinux aria-label="Target 2.1: SELinux">Target 2.1: SELinux</a></li></ul>
</li><li>
<a href=#target-3-autostart-on-boot aria-label="Target 3: Autostart on boot">Target 3: Autostart on boot</a></li><li>
<a href=#target-4-automatic-updates aria-label="Target 4: Automatic updates">Target 4: Automatic updates</a></li><li>
<a href=#bonus-mail-on-unit-startfailure aria-label="Bonus: Mail on unit start/failure">Bonus: Mail on unit start/failure</a></li></ul>
</div>
</details>
</div>
<div class=post-content>
<p>I doubt I&rsquo;ll be alone when I say that my server setup is a mess. It is a monolith of different services slammed
together on the same machine. Some run on the bare metal, some run in a VM, some run in containers.</p>
<p>Recently I put some work into migrating my applications away from bare metal and into containers. While that
effort is not complete just yet, it has already broken on me after <code>podman-compose</code> stopped creating pods per
compose file. Apparently that was a bug, and I relied on this behaviour with a wrapper script.</p>
<p>The sequence this script followed is rather simple:</p>
<ol>
<li>Remove any existing podman-generated systemd unit files from <code>~/.config/systemd/system</code></li>
<li>Run <code>podman-compose up</code></li>
<li>Generate new system files with <code>podman generate systemd</code></li>
<li>Move all <code>*.service</code> files generated to the <code>~/.config/systemd/system</code> directory</li>
</ol>
<p>However, this relied on the previous behaviour in podman-compose which created a pod for all services to live in per
compose file, so it can guess the pod name and generate a set of systemd units for it with one invocation of the
<code>podman generate systemd</code> command. Nifty, worked for a while, but now it&rsquo;s time to move on.</p>
<h1 id=the-puzzle-pieces>The puzzle pieces<a hidden class=anchor aria-hidden=true href=#the-puzzle-pieces>#</a></h1>
<p>Let&rsquo;s lay out what we want to achieve.</p>
<ul>
<li>For security, containers should be rootless</li>
<li>For maintainability, containers should be defined in a <code>docker-compose.yml</code> file</li>
<li>For usability, containers should auto-start on boot</li>
<li>Purely for the sake of laziness we&rsquo;ll throw in the extra requirement that containers should be self-updating
<ul>
<li>This might haunt me later. We&rsquo;ll see about that, but because of this it should be trivial to disable</li>
</ul>
</li>
</ul>
<h1 id=target-1-rootless>Target 1: Rootless<a hidden class=anchor aria-hidden=true href=#target-1-rootless>#</a></h1>
<p>I refuse to run my containers in a rootful environment. I strongly believe that podman is designed to remedy this
design decision in Docker and I should take advantage of that.</p>
<p>My containers run as a separate <code>podman</code> user with virtually no privileges on the system. Most containers run the
software they host under a different user as well, which means that it&rsquo;s practically impossible for container X to
touch container Y&rsquo;s files.</p>
<p>This imposes challenges when you want to share folders between containers, but that&rsquo;s something a little GID magic can
solve; give the containers the same GID and set a restrictive permission mask on that, so the actual owner gets write
permissions yet other containers get read permission only.</p>
<h1 id=target-2-docker-compose>Target 2: docker-compose<a hidden class=anchor aria-hidden=true href=#target-2-docker-compose>#</a></h1>
<p>The standard docker-compose now works with podman v3!</p>
<p>A standard docker-compose.yml file should be sufficient. As an example, below is the configuration file for my Nextcloud instance:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:alpine</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/containers/nextcloud/db:/var/lib/postgresql/data</span><span class=w>
</span><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_PASSWORD=VERY_SECURE_POSTGRESQL_PASSWORD_HERE</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:alpine</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nextcloud:apache</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>81</span><span class=p>:</span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/containers/nextcloud/html:/var/www/html</span><span class=w>
</span><span class=w>      </span>- <span class=l>/mnt/storage/Nextcloud:/var/www/html/data</span><span class=w>
</span><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_HOST=db</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_PASSWORD=VERY_SECURE_NEXTCLOUD_POSTGRESQL_PASSWORD_HERE</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_DB=nextcloud</span><span class=w>
</span><span class=w>      </span>- <span class=l>POSTGRES_USER=ncuser</span><span class=w>
</span><span class=w>      </span>- <span class=l>REDIS_HOST=redis</span><span class=w>
</span><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>db.env</span><span class=w>
</span><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>db</span><span class=w>
</span><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>cron</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nextcloud:apache</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/containers/nextcloud/html:/var/www/html</span><span class=w>
</span><span class=w>      </span>- <span class=l>/mnt/storage/Nextcloud:/var/www/html/data</span><span class=w>
</span><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=l>/cron.sh</span><span class=w>
</span><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>db</span><span class=w>
</span><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span><span class=w>      
</span><span class=w>  </span><span class=nt>onlyoffice</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;onlyoffice/documentserver&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s1>&#39;9980:80&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_TYPE</span><span class=p>:</span><span class=w> </span><span class=l>postgres</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_HOST</span><span class=p>:</span><span class=w> </span><span class=l>db</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_PORT</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_NAME</span><span class=p>:</span><span class=w> </span><span class=l>onlyoffice</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_USER</span><span class=p>:</span><span class=w> </span><span class=l>onlyoffice</span><span class=w>
</span><span class=w>      </span><span class=nt>DB_PWD</span><span class=p>:</span><span class=w> </span><span class=l>VERY_SECURE_ONLYOFFICE_POSTGRESQL_PASSWORD_HERE</span><span class=w>
</span><span class=w>      </span><span class=nt>JWT_ENABLED</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span><span class=w>      </span><span class=nt>JWT_SECRET</span><span class=p>:</span><span class=w> </span><span class=l>VERY_SECURE_JWT_SECRET_HERE</span><span class=w>
</span><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>/containers/onlyoffice/logs:/var/log/onlyoffice</span><span class=w>
</span><span class=w>      </span>- <span class=l>/containers/onlyoffice/certificates:/var/www/onlyoffice/Data</span><span class=w>
</span><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>db</span><span class=w>
</span><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>always</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The only thing really of note is that every service has <code>restart: always</code> set. This will be explained later.</p>
<blockquote>
<p>Please note that rootless containers might not have the same privileges as a rootful container in terms of networking etcetera. <strong>Always double check the compose files you copy!</strong></p>
</blockquote>
<blockquote>
<p>It is preferred that you use the podman secrets infrastructure for passwords instead of hardcoding them into this text file. This is beyond the scope of this article, do some research!</p>
</blockquote>
<h2 id=target-21-selinux>Target 2.1: SELinux<a hidden class=anchor aria-hidden=true href=#target-21-selinux>#</a></h2>
<p>Fedora has SELinux enabled by default, and <a href=https://stopdisablingselinux.com/>we don&rsquo;t want to make Dan Walsh weep</a>. Thankfully, setting up SELinux to play nice with your containers is trivial.</p>
<p>What I like to do is create a <code>/containers</code> directory (yes, in the root folder) whose owner I set to the podman user. After this it is just a matter of making sure the directory has the right SELinux type label, which is <code>container_file_t</code>. You can achieve this with the following command:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>semanage fcontext -a -t container_file_t <span class=s1>&#39;/containers(/.*)?&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>This will ensure that the <code>/containers</code> directory <em>and all of its sub-directories and files</em> will get the appropriate SELinux type applied. This however does not immediately apply to existing files or directories, so we can apply it by running:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>restorecon -Rv /containers
</code></pre></td></tr></table>
</div>
</div><p>If all is well you should be seeing a lot of label changes being printed to the console, depending on how many files exist in this directory.</p>
<h1 id=target-3-autostart-on-boot>Target 3: Autostart on boot<a hidden class=anchor aria-hidden=true href=#target-3-autostart-on-boot>#</a></h1>
<p>This took me too long to figure out, but it turns out that Podman already ships with a solution built in. Remember the <code>restart: always</code> that I mentioned earlier?</p>
<p>It turns out Podman ships with a systemd unit file specifically to start all containers marked to always restart. It is called <code>podman-restart.service</code> and it can be enabled as a user service!</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>systemctl <span class=nb>enable</span> --user podman-restart.service
</code></pre></td></tr></table>
</div>
</div><p>Start a container marked with <code>restart: always</code>, and then reboot your system. Nothing happens, congratulations!</p>
<p>By default, user units are only started whenever the user starts a session. Since nobody has logged in to your podman user, no session was ever started. Even worse, should someone login as the podman user, the session will start, which will start your container - and then it will get killed when that person logs out. That&rsquo;s super inconvenient.</p>
<p>systemd-logind has a concept of <em>lingering users</em>. The <code>loginctl</code> man page describes it as:</p>
<blockquote>
<p>&mldr; If enabled for a specific user, a user manager is spawned for the user at boot and kept around after logouts. This allows users who are not logged in to run long-running services. &mldr;</p>
</blockquote>
<p>We can enable this for our podman user with the following command:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>loginctl enable-linger PODMAN-USER-HERE
</code></pre></td></tr></table>
</div>
</div><p>Set that, reboot again and you should see it all start to come together.</p>
<h1 id=target-4-automatic-updates>Target 4: Automatic updates<a hidden class=anchor aria-hidden=true href=#target-4-automatic-updates>#</a></h1>
<p>The tricky part. We can have dnf automatic updates through <code>dnf-automatic</code>, and Podman even <a href=https://docs.podman.io/en/latest/markdown/podman-auto-update.1.html>has its own auto-update system</a>! However, we cannot use this in this setup, because we do not rely on per-container systemd unit files, because we use podman-compose and the global <code>podman-restart.service</code>.</p>
<p>Instead, what we can do is replicate the setup using custom unit files per docker-compose file. Create the following file at <code>~/.config/systemd/user/podman-update@.service</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=k>[Unit]</span>
<span class=na>Description</span><span class=o>=</span><span class=s>Podman auto-update service for %i</span>
<span class=na>Wants</span><span class=o>=</span><span class=s>network-online.target</span>
<span class=na>After</span><span class=o>=</span><span class=s>network-online.target</span>

<span class=k>[Service]</span>
<span class=na>WorkingDirectory</span><span class=o>=</span><span class=s>%h/infra/%i</span>
<span class=na>Environment</span><span class=o>=</span><span class=s>&#34;DOCKER_HOST=unix:%t/podman/podman.sock&#34;</span>
<span class=na>Type</span><span class=o>=</span><span class=s>oneshot</span>
<span class=na>ExecStart</span><span class=o>=</span><span class=s>/usr/bin/docker-compose pull</span>
<span class=na>ExecStartPost</span><span class=o>=</span><span class=s>/usr/bin/docker-compose up -d</span>
<span class=na>ExecStartPost</span><span class=o>=</span><span class=s>/usr/bin/podman image prune -f</span>

<span class=c1># Uncomment the following if you want to have e-mail notifications</span>
<span class=c1>#ExecStopPost=/usr/bin/unit-status-mail-user.sh %n &#34;Hostname: %H&#34; &#34;Machine ID: %m&#34; &#34;Boot ID: %b&#34;</span>

<span class=k>[Install]</span>
<span class=na>WantedBy</span><span class=o>=</span><span class=s>default.target</span>
</code></pre></td></tr></table>
</div>
</div><p>This is a template file which can be used multiple times with a different input parameter (the string after the @ sign).</p>
<blockquote>
<p><strong>Make sure to check the WorkingDirectory setting!</strong> This assumes you have your docker-compose.yml files stored in ~/infra/[subfolder]/docker-compose.yml</p>
</blockquote>
<p>And add the following timer at <code>~/.config/systemd/user/podman-update@.timer</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=k>[Unit]</span>
<span class=na>Description</span><span class=o>=</span><span class=s>Podman update timer for %i</span>

<span class=k>[Timer]</span>
<span class=na>OnCalendar</span><span class=o>=</span><span class=s>daily</span>
<span class=na>RandomizedDelaySec</span><span class=o>=</span><span class=s>900</span>
<span class=na>Persistent</span><span class=o>=</span><span class=s>true</span>

<span class=k>[Install]</span>
<span class=na>WantedBy</span><span class=o>=</span><span class=s>timers.target</span>
</code></pre></td></tr></table>
</div>
</div><p>For every subfolder, you can now enable the timer, which will call the unit:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>systemctl --user <span class=nb>enable</span> podman-update@nextcloud.timer
</code></pre></td></tr></table>
</div>
</div><p>Where <code>nextcloud</code> is a subfolder of <code>~/infra</code>. Your nextcloud container will now update daily at midnight!</p>
<h1 id=bonus-mail-on-unit-startfailure>Bonus: Mail on unit start/failure<a hidden class=anchor aria-hidden=true href=#bonus-mail-on-unit-startfailure>#</a></h1>
<p><a href=https://www.northernlightlabs.se/2014-07-05/systemd-status-mail-on-unit-failure.html>northernlights.se has a great resource on automatically mailing unit status after a unit starts or stops.</a></p>
<p>To adjust this approach for user unit files, create <code>/usr/bin/unit-status-mail-user.sh</code> with:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=nv>MAILTO</span><span class=o>=</span><span class=s2>&#34;root&#34;</span>
<span class=nv>MAILFROM</span><span class=o>=</span><span class=s2>&#34;unit-status-mailer&#34;</span>
<span class=nv>UNIT</span><span class=o>=</span><span class=nv>$1</span>

<span class=nv>EXTRA</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=k>for</span> e in <span class=s2>&#34;</span><span class=si>${</span><span class=p>@:</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
  <span class=nv>EXTRA</span><span class=o>+=</span><span class=s2>&#34;</span><span class=nv>$e</span><span class=s2>&#34;</span><span class=s1>$&#39;\n&#39;</span>
<span class=k>done</span>

<span class=nv>UNITSTATUS</span><span class=o>=</span><span class=k>$(</span>systemctl status --user <span class=nv>$UNIT</span><span class=k>)</span>

sendmail <span class=nv>$MAILTO</span> <span class=s>&lt;&lt;EOF
</span><span class=s>From:$MAILFROM
</span><span class=s>To:$MAILTO
</span><span class=s>Subject:Status mail for unit: $UNIT
</span><span class=s>
</span><span class=s>Status report for unit: $UNIT
</span><span class=s>$EXTRA
</span><span class=s>
</span><span class=s>$UNITSTATUS
</span><span class=s>EOF</span>

<span class=nb>echo</span> -e <span class=s2>&#34;Status mail sent to: </span><span class=nv>$MAILTO</span><span class=s2> for unit: </span><span class=nv>$UNIT</span><span class=s2>&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Then uncomment the commented line in the systemd service above. Don&rsquo;t forget to <code>chmod +x</code> the file and add SELinux rules:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>chmod +x /usr/bin/unit-status-mail.sh /usr/bin/unit-status-mail-user.sh
restorecon -vF /usr/bin/unit-status-mail.sh
restorecon -vF /usr/bin/unit-status-mail-user.sh
</code></pre></td></tr></table>
</div>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://www.nanosector.nl/tags/howto/>howto</a></li>
<li><a href=https://www.nanosector.nl/tags/software/>software</a></li>
</ul>
</footer>
</article>
</main><footer class=footer>
<span>&copy; 2022 <a href=https://www.nanosector.nl/>Nano's Blog</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>